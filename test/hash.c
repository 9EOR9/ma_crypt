#include <stdio.h>
#include <string.h>
#include <ma_hash.h>
#include <tap.h>

char *varstr;
#define MAX_VAR_STR 1000000
#define MAX_DIGEST_SIZE 64

struct st_test {
  unsigned int hash_alg;
  unsigned int repetitions;
  const char *source;
  const char *digest;
};

unsigned int compare_results(const char *src, const char *result, unsigned int size)
{
  char hex[MAX_DIGEST_SIZE * 2 + 1];
  char *p= hex;
  int i=0;

  while (i++ < size) {
    sprintf(p, "%02X", (unsigned char)*src++);
    p+= 2;
  }
  if (memcmp(hex, result, size) == 0)
    return 1;
  diag("result: %s\n", hex);
  diag("expect: %s\n", result);
  return 0;
}

struct st_test my_tests[]= {
  /* MD5 - RFC 1321 */
  {
    MA_HASH_MD5, 1,
    "",
    "D41D8CD98F00B204E9800998ECF8427E",
  },
  {
    MA_HASH_MD5, 1,
    "a",
    "0CC175B9C0F1B6A831C399E269772661",
  },
  {
    MA_HASH_MD5, 1,
    "abc",
    "900150983CD24FB0D6963F7D28E17F72",
  },
  {
    MA_HASH_MD5, 1,
    "message digest",
    "F96B697D7CB7938D525A2F31AAF161D0",
  },
  {
    MA_HASH_MD5, 1,
    "abcdefghijklmnopqrstuvwxyz",
    "C3FCD3D76192E4007DFB496CCA67E13B",
  },
  {
    MA_HASH_MD5, 1,
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",
    "D174AB98D277D9F5A5611C2C9F419D9F",
  },
  {
    MA_HASH_MD5, 1,
    "12345678901234567890123456789012345678901234567890123456789012345678901234567890",
    "57EDF4A22BE3C955AC49DA2E2107B67A",
  },
  /* SHA1 - RFC 3174 */
  {
    MA_HASH_SHA1, 1,
    "abc",
    "A9993E364706816ABA3E25717850C26C9CD0D89D"
  },
  {
    MA_HASH_SHA1, 1,
    "abcdbcdecdefdefgefghfghighijhijkijkljklmklmnlmnomnopnopq",
    "84983E441C3BD26EBAAE4AA1F95129E5E54670F1"
  },
  {
    MA_HASH_SHA1, 1000000,
    "a",
    "34AA973CD4C4DAA4F61EEB2BDBAD27316534016F"
  },
  {
    MA_HASH_SHA1, 10,
    "0123456701234567012345670123456701234567012345670123456701234567",
    "DEA356A2CDDD90C7A7ECEDC5EBB563934F460452"
  },
  /* SHA224 - RFC 3874 */
  { 
    MA_HASH_SHA224, 1,
    "abc",
    "23097D223405D8228642A477BDA255B32AADBCE4BDA0B3F7E36C9DA7"
  },
  {
    MA_HASH_SHA224, 1,
    "abcdbcdecdefdefgefghfghighijhijkijkljklmklmnlmnomnopnopq",
    "75388B16512776CC5DBA5DA1FD890150B0C6455CB4F58B1952522525"
  },
  {
    MA_HASH_SHA224, 1000000,
    "a",
    "20794655980C91D8BBB4C1EA97618A4BF03F42581948B2EE4EE7AD67"
  },
  /* SHA256 - FIPS 180-2 tests  */
  {
    MA_HASH_SHA256, 1,
    "abc",
    "BA7816BF8F01CFEA414140DE5DAE2223B00361A396177A9CB410FF61F20015AD"
  },
  {
    MA_HASH_SHA256, 1,
    "abcdbcdecdefdefgefghfghighijhijkijkljklmklmnlmnomnopnopq",
    "248D6A61D20638B8E5C026930C3E6039A33CE45964FF2167F6ECEDD419DB06C1"
  },
  {
    MA_HASH_SHA256, 1,
    "abcdefghbcdefghicdefghijdefghijkefghijklfghijklmghijklmn"
      "hijklmnoijklmnopjklmnopqklmnopqrlmnopqrsmnopqrstnopqrstu",
    "CF5B16A778AF8380036CE59E7B0492370B249B11E8F07A51AFAC45037AFEE9D1"
  },
  /* Additional test vectors, from Daniel Kahn Gillmor */
  {
    MA_HASH_SHA256, 1,
    "",
    "E3B0C44298FC1C149AFBF4C8996FB92427AE41E4649B934CA495991B7852B855"
  },
  {
    MA_HASH_SHA256, 1,
    "a",
    "CA978112CA1BBDCAFAC231B39A23DC4DA786EFF8147C4E72B9807785AFEE48BB"
  },
  {
    MA_HASH_SHA256, 1,
    "38",
    "AEA92132C4CBEB263E6AC2BF6C183B5D81737F179F21EFDC5863739672F0F470"
  },
  {
    MA_HASH_SHA256, 1,
    "message digest",
    "F7846F55CF23E14EEBEAB5B4E1550CAD5B509E3348FBC4EFA3A1413D393CB650"
  },
  {
    MA_HASH_SHA256, 1,
    "abcdefghijklmnopqrstuvwxyz",
    "71C480DF93D6AE2F1EFAD1447C66C9525E316218CF51FC8D9ED832F2DAF18B73"
  },
  {
    MA_HASH_SHA256, 1,
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",
    "DB4BFCBD4DA0CD85A60C3C37D3FBD8805C77F15FC6B1FDFE614EE0A7C8FDB4C0"
  },
  {
    MA_HASH_SHA256, 1,
    "12345678901234567890123456789012"
      "345678901234567890123456789012345678901234567890",
    "F371BC4A311F2B009EEF952DD83CA80E2B60026C8E935592D0F9C308453C813E"
  },
  /* SHA384 - nettle tests */
  {
    MA_HASH_SHA384, 1,
    "abc",
    "CB00753F45A35E8BB5A03D699AC65007272C32AB0EDED1631A8B605A43FF5BED8086072BA1E7CC2358BAECA134C825A7"
  },
  { 
    MA_HASH_SHA384, 1,
    "abcdefghbcdefghicdefghijdefghijkefghijklfghijklmghijklmn"
      "hijklmnoijklmnopjklmnopqklmnopqrlmnopqrsmnopqrstnopqrstu",
    "09330C33F71147E83D192FC782CD1B4753111B173B3B05D22FA08086E3B0F712FCC7C71A557E2DB966C3E9FA91746039"
  },
  /* Additional test vectors, from Daniel Kahn Gillmor */
  {
    MA_HASH_SHA384, 1,
    "",
    "38B060A751AC96384CD9327EB1B1E36A21FDB71114BE07434C0CC7BF63F6E1DA274EDEBFE76F65FBD51AD2F14898B95B"
  },
  {
    MA_HASH_SHA384, 1,
    "a",
    "54A59B9F22B0B80880D8427E548B7C23ABD873486E1F035DCE9CD697E85175033CAA88E6D57BC35EFAE0B5AFD3145F31"
  },
  {
    MA_HASH_SHA384, 1,
    "38",
    "C071D202AD950B6A04A5F15C24596A993AF8B212467958D570A3FFD4780060638E3A3D06637691D3012BD31122071B2C"
  },
  {
    MA_HASH_SHA384, 1,
    "message digest",
    "473ED35167EC1F5D8E550368A3DB39BE54639F828868E9454C239FC8B52E3C61DBD0D8B4DE1390C256DCBB5D5FD99CD5"
  },
  {
    MA_HASH_SHA384, 1,
    "abcdefghijklmnopqrstuvwxyz",
    "FEB67349DF3DB6F5924815D6C3DC133F091809213731FE5C7B5F4999E463479FF2877F5F2936FA63BB43784B12F3EBB4"
  },
  {
    MA_HASH_SHA384, 1,
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",
    "1761336E3F7CBFE51DEB137F026F89E01A448E3B1FAFA64039C1464EE8732F11A5341A6F41E0C202294736ED64DB1A84"
  },
  {
    MA_HASH_SHA384, 1,
    "12345678901234567890123456789012345678901234567890123456789012345678901234567890",
    "B12932B0627D1C060942F5447764155655BD4DA0C9AFA6DD9B9EF53129AF1B8FB0195996D2DE9CA0DF9D821FFEE67026"
  },
  /* SHA-512 */
  {
    MA_HASH_SHA512, 1,
    "abc",
    "DDAF35A193617ABACC417349AE20413112E6FA4E89A97EA20A9EEEE64B55D39A"
      "2192992A274FC1A836BA3C23A3FEEBBD454D4423643CE80E2A9AC94FA54CA49F"
  },
  {
    MA_HASH_SHA512, 1,
    "abcdefghbcdefghicdefghijdefghijkefghijklfghijklmghijklmn"
      "hijklmnoijklmnopjklmnopqklmnopqrlmnopqrsmnopqrstnopqrstu",
    "8E959B75DAE313DA8CF4F72814FC143F8F7779C6EB9F7FA17299AEADB6889018"
      "501D289E4900F7E4331B99DEC4B5433AC7D329EEB6DD26545E96E55B874BE909"
  },
  /* NESSIE, Set 1, vector #6 */
  {
    MA_HASH_SHA512, 1,
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",
    "1E07BE23C26A86EA37EA810C8EC7809352515A970E9253C26F536CFC7A9996C4"
      "5C8370583E0A78FA4A90041D71A4CEAB7423F19C71B9D5A3E01249F0BEBD5894"
  },
  /* NESSIE, Set 1, vector #7 */
  {
    MA_HASH_SHA512, 1,
    "12345678901234567890123456789012345678901234567890123456789012345678901234567890",
    "72EC1EF1124A45B047E8B7C75A932195135BB61DE24EC0D1914042246E0AEC3A"
      "2354E093D76F3048B456764346900CB130D2A4FD5DD16ABB5E30BCB850DEE843"
  },
  /* Variants longer than one block (128 bytes), to test varying alignment. */
  {
    MA_HASH_SHA512, 3,
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",
    "5338370F5655F4DA14572D4FB471539B201485ECFB3D3204048DC6B83E61FAB5"
      "05BCBBD73E644A1A5D159A32A0889CF3C9591B69B26D31BE56C68838CE3CD63D"
  },
  {
    MA_HASH_SHA512, 8,
    "1234567890123456789012345678901234567890",
    "33F8901B053E4CC677D3CB4122D96AD9B96B13BF76194CF962488BB4DE4998A7"
      "1455CB31582DB527ADF77A485B81CF5B722A5E8638EB6BE487400F3AEC006E7C"
  },
  /* Additional test vectors, from Daniel Kahn Gillmor */
  {
    MA_HASH_SHA512, 1,
    "", 
    "CF83E1357EEFB8BDF1542850D66D8007D620E4050B5715DC83F4A921D36CE9CE"
      "47D0D13C5D85F2B0FF8318D2877EEC2F63B931BD47417A81A538327AF927DA3E"
  },
  {
    MA_HASH_SHA512, 1,
    "a",
    "1F40FC92DA241694750979EE6CF582F2D5D7D28E18335DE05ABC54D0560E0F53"
      "02860C652BF08D560252AA5E74210546F369FBBBCE8C12CFC7957B2652FE9A75"
  },
  {
    MA_HASH_SHA512, 1,
    "38",
    "CAAE34A5E81031268BCDAF6F1D8C04D37B7F2C349AFB705B575966F63E2EBF0F"
      "D910C3B05160BA087AB7AF35D40B7C719C53CD8B947C96111F64105FD45CC1B2"
  },
  {
    MA_HASH_SHA512, 1,
    "message digest",
    "107DBF389D9E9F71A3A95F6C055B9251BC5268C2BE16D6C13492EA45B0199F33"
      "09E16455AB1E96118E8A905D5597B72038DDB372A89826046DE66687BB420E7C"
  },
  {
    MA_HASH_SHA512, 1,
    "abcdefghijklmnopqrstuvwxyz",
    "4DBFF86CC2CA1BAE1E16468A05CB9881C97F1753BCE3619034898FAA1AABE429"
      "955A1BF8EC483D7421FE3C1646613A59ED5441FB0F321389F77F48A879C7B1F1"
  },
  {
    MA_HASH_SHA512, 1,
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",
    "1E07BE23C26A86EA37EA810C8EC7809352515A970E9253C26F536CFC7A9996C4"
      "5C8370583E0A78FA4A90041D71A4CEAB7423F19C71B9D5A3E01249F0BEBD5894"
  },
  {
    MA_HASH_SHA512, 1,
    "12345678901234567890123456789012345678901234567890123456789012345678901234567890",
    "72EC1EF1124A45B047E8B7C75A932195135BB61DE24EC0D1914042246E0AEC3A"
      "2354E093D76F3048B456764346900CB130D2A4FD5DD16ABB5E30BCB850DEE843"
  }
};

char *algorithms[] = { "MD5", "SHA1", "SHA224", "SHA256", "SHA384", "SHA512" };

int main()
{
  char digest[MAX_DIGEST_SIZE];
  int i, j;
  MA_HASH_CTX ctx;
  char test_name[50];
  plan(sizeof(my_tests) / sizeof(struct st_test));
  for (i= 0; i < sizeof(my_tests) / sizeof(struct st_test); i++)
  {
    if ((ctx= ma_hash_new(my_tests[i].hash_alg)))
    {
      sprintf(test_name, "%s %d", algorithms[my_tests[i].hash_alg], i);
      for (j=0; j < my_tests[i].repetitions; j++)
      {
        const char *src= my_tests[i].source;
        ma_hash_input(ctx, src, strlen(src));
      }
      ma_hash_result(ctx, digest);
      ok(compare_results(digest, my_tests[i].digest, ma_hash_digest_size(my_tests[i].hash_alg)),
         test_name);
      ma_hash_free(ctx);
    }
  }
  done_testing();
}
